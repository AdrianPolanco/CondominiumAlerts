<form [formGroup]="form()" (ngSubmit)="onSubmit()" class="space-y-4 p-4">
  @for(field of fields(); track field;){
    <div class="flex flex-col">
      <label [for]="field.name" class="font-medium">{{ field.label }}</label>

      @if (field.icon) {
        <p-inputgroup>
          <p-inputgroup-addon>
            <i class="pi" [ngClass]="field.icon"></i>
          </p-inputgroup-addon>
          @if(field.type === 'text' || field.type === 'number'){
            <input
              pInputText
              [type]="field.type"
              [id]="field.name"
              [formControlName]="field.name"
              class="p-inputtext w-full disabled:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-50 " />
          }@else if(field.type === 'password'){
            <div class="w-full">
              <p-password
                [id]="field.name"
                [formControlName]="field.name"
                [toggleMask]="true"
                styleClass="w-full"
                [inputStyleClass]="'w-full px-4 py-2 border border-gray-300 rounded-l-none rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all disabled:bg-gray-100'"
              />
            </div>
          }
        </p-inputgroup>
      } @else {
        @if(field.type === 'text' || field.type === 'number'){
          <input
            pInputText
            [type]="field.type"
            [id]="field.name"
            [formControlName]="field.name"
            class="p-inputtext w-full disabled:bg-gray-100" />
        }@else if(field.type === 'password'){
          <div class="w-full">
            <p-password
              [id]="field.name"
              [formControlName]="field.name"
              [toggleMask]="true"
              styleClass="w-full"
              [inputStyleClass]="'w-full px-4 py-2 border border-gray-300 rounded-l-none rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all disabled:bg-gray-100'"
            />
          </div>
        }
      }

      @if (field.type === 'textarea') {
        <textarea pTextarea
                  [id]="field.name"
                  [formControlName]="field.name"
                  class="p-inputtextarea w-full disabled:bg-gray-100"
        ></textarea>
      }

      @if (field.type === 'file' && isFileField(field)) {
        <p-fileUpload
          [id]="field.name"
          [name]="field.name"
          mode="basic"
          [chooseLabel]="field.label"
          (onSelect)="field.onFileSelect($event)"
          [accept]="field.filetype"
        ></p-fileUpload>
      }

      @if (field.type === 'select') {
        <p-dropdown
          [options]="field.options"
          [formControlName]="field.name"
          [id]="field.name"
          placeholder="Selecciona una opciÃ³n" class="w-full  disabled:bg-gray-100"></p-dropdown>
      }

      @if (field.type === 'checkbox') {
        <p-checkbox
          [formControlName]="field.name"
          [id]="field.name"
          class="disabled:bg-gray-100"
          binary="true"></p-checkbox>
      }

      @if ((form().get(field.name)?.invalid && form().get(field.name)?.touched) ||
     (field.showFormErrors && form().errors && form().get(field.name)?.touched)) {
        <div *ngFor="let msg of feedback()?.message?.split(', ')">
          <span>{{ msg }}</span>
        </div>
    }
    </div>
  }

  <button
    pButton
    type="submit"
    [class]="(form().invalid) ?
    'p-button w-full flex justify-center items-center !bg-gray-400 hover:!bg-gray-400 !border-gray-400' :
    'p-button w-full flex justify-center items-center shadow-md active:shadow-none'"
    [disabled]="form().invalid || isLoading()"
  >
    @if(isLoading()) {
      <div class="flex items-center gap-2">
        <p-progress-spinner
          [style]="{width: '20px', height: '20px'}"
          styleClass="custom-spinner"
          strokeWidth="4"
          fill="var(--surface-ground)"
          animationDuration=".5s"
        />
      </div>
    }@else if(!isLoading() && feedback()?.status === 'success'){
      <span>{{formSettingsInput().submittedButtonLabel}}</span>
    } @else {
      <span>{{formSettingsInput().baseButtonLabel}}</span>
    }
  </button>

  @if(feedback() && feedback()?.status !== 'none'){
    <div class="flex justify-center items-center gap-2">
      <div>
        @if(feedback()?.status === 'success'){
          <i class="pi pi-check-circle text-green-500"></i>
          <span class="inline-block">{{ feedback()?.message}}</span>
        }@else if(feedback()?.status === 'error'){
          <div *ngFor="let msg of feedback()?.message?.split(', ')" class="flex items-center gap-2">
            <i class="pi pi-times-circle text-red-500"></i>
            <span class="inline-block">{{ msg }}</span>
          </div>
        }
      </div>
    </div>
  }
</form>
